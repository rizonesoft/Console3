name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CMAKE_GENERATOR: "Visual Studio 18 2026"
  BUILD_TYPE: Release

jobs:
  build-release:
    name: Build ${{ matrix.config.name }}
    runs-on: windows-latest
    
    strategy:
      matrix:
        config:
          - name: x64
            arch: x64
            avx2: OFF
            artifact_suffix: x64_v144
          - name: x64_AVX2
            arch: x64
            avx2: ON
            artifact_suffix: AVX2_x64_v144
          - name: ARM64
            arch: ARM64
            avx2: OFF
            artifact_suffix: ARM64_v144

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake
      run: |
        $outputDir = "${{ github.workspace }}\Bin\${{ env.BUILD_TYPE }}_${{ matrix.config.artifact_suffix }}"
        cmake -B build `
          -G "${{ env.CMAKE_GENERATOR }}" `
          -A ${{ matrix.config.arch }} `
          -DENABLE_AVX2=${{ matrix.config.avx2 }} `
          -DCMAKE_RUNTIME_OUTPUT_DIRECTORY="$outputDir" `
          -DCMAKE_LIBRARY_OUTPUT_DIRECTORY="$outputDir" `
          -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY="$outputDir\lib"
      shell: pwsh

    - name: Build
      run: |
        cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

    - name: Create Package
      run: |
        $version = "${{ github.ref_name }}"
        $suffix = "${{ matrix.config.artifact_suffix }}"
        $binDir = "Bin\${{ env.BUILD_TYPE }}_$suffix"
        $packageName = "Console3-${version}-${suffix}"
        
        # Create release directory
        New-Item -ItemType Directory -Force -Path "release"
        
        # Copy main binaries (exclude obj, lib subdirs)
        Get-ChildItem -Path $binDir -File | Where-Object { $_.Extension -in '.exe', '.dll' } | Copy-Item -Destination "release\"
        
        # Create ZIP
        Compress-Archive -Path "release\*" -DestinationPath "${packageName}.zip" -Force
        
        Write-Host "Created: ${packageName}.zip"
      shell: pwsh

    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        name: Console3-${{ github.ref_name }}-${{ matrix.config.artifact_suffix }}
        path: Console3-${{ github.ref_name }}-${{ matrix.config.artifact_suffix }}.zip

  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*.zip
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
